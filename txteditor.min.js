(function(){function doSave(e){savedSelection=saveSelection(e)}function doRestore(e){if(savedSelection){restoreSelection(e,savedSelection)}}function insertNodeAtCaret(e){if(typeof window.getSelection!="undefined"){var t=window.getSelection();if(t.rangeCount){var n=t.getRangeAt(0);n.collapse(false);n.insertNode(e);n=n.cloneRange();n.selectNodeContents(e);n.collapse(false);t.removeAllRanges();t.addRange(n)}}else if(typeof document.selection!="undefined"&&document.selection.type!="Control"){var r=e.nodeType==1?e.outerHTML:e.data;var i="marker_"+(""+Math.random()).slice(2);r+='<span id="'+i+'"></span>';var s=document.selection.createRange();s.collapse(false);s.pasteHTML(r);var o=document.getElementById(i);s.moveToElementText(o);s.select();o.parentNode.removeChild(o)}}function insertNodeAtCaret(e){if(typeof window.getSelection!="undefined"){var t=window.getSelection();if(t.rangeCount){var n=t.getRangeAt(0);n.collapse(false);n.insertNode(e);n=n.cloneRange();n.selectNodeContents(e);n.collapse(false);t.removeAllRanges();t.addRange(n)}}else if(typeof document.selection!="undefined"&&document.selection.type!="Control"){var r=e.nodeType==1?e.outerHTML:e.data;var i="marker_"+(""+Math.random()).slice(2);r+='<span id="'+i+'"></span>';var s=document.selection.createRange();s.collapse(false);s.pasteHTML(r);var o=document.getElementById(i);s.moveToElementText(o);s.select();o.parentNode.removeChild(o)}}function pastethehtml(e){var t,n;if(window.getSelection){t=window.getSelection();if(t.getRangeAt&&t.rangeCount){n=t.getRangeAt(0);n.deleteContents();var r=document.createElement("div");r.innerHTML=e;var i=document.createDocumentFragment(),s,o;while(s=r.firstChild){o=i.appendChild(s)}n.insertNode(i);if(o){n=n.cloneRange();n.setStartAfter(o);n.collapse(true);t.removeAllRanges();t.addRange(n)}}}else if(document.selection&&document.selection.type!="Control"){document.selection.createRange().pasteHTML(e)}}function dropcancel(e){e=e||event;change_back();e.preventDefault()}function change(e){e.stopPropagation();e.preventDefault();var t=$(".txteditpop");t.css("border","2px dotted lightgrey");t.find("#txt_camera").text("DROP HERE");console.log("drop here")}function change_back(){var e=$(".txteditpop");e.css("border","none");e.find("#txt_camera").text("UPLOAD IMAGE");console.log("drop back")}$.fn.txteditor=function(e){function i(){var e="";if(window.getSelection){e=window.getSelection()}else if(document.selection&&document.selection.type!="Control"){e=document.selection.createRange()}return e}var t=$.extend({url:"upload.php"},e);var n=$(".txteditpop");var r=$(".txtback");if(n.length<=0){n=$('<div class="txteditpop"><div class="txteditclose">X</div><div class="txteditcontent"></div><div class="txtcntrlbox"></div></div>').appendTo("body")}if(r.length<=0){r=$('<div class="txtback"></div>').appendTo("body")}return this.each(function(){function v(){s.find(".txtedit").css("opacity","").removeClass("slctbt");if(document.queryCommandState("bold")){s.find(".tbbold").css("opacity","1").addClass("slctbt").addClass("slctbt")}if(document.queryCommandState("underline")){s.find(".tbud").css("opacity","1").addClass("slctbt")}if(document.queryCommandState("italic")){s.find(".tbit").css("opacity","1").addClass("slctbt")}if(document.queryCommandState("justifyleft")){s.find(".tbal").css("opacity","1").addClass("slctbt")}if(document.queryCommandState("justifycenter")){s.find(".tbac").css("opacity","1").addClass("slctbt")}if(document.queryCommandState("justifyright")){s.find(".tbarn").css("opacity","1").addClass("slctbt")}if(document.queryCommandState("insertorderedlist")){s.find(".tbol").css("opacity","1").addClass("slctbt")}if(document.queryCommandState("insertunorderedlist")){s.find(".tbul").css("opacity","1").addClass("slctbt")}var e;var t;var n=0;if(window.getSelection){e=window.getSelection();t=e.anchorNode.parentNode;n=1}else{e=document.selection.createRange();if(e.parentElement){t=e.parentElement();n=2}else{t=e.item(0);n=3}}if(t.className!=="textareaposting"){while(!t.className.match(/postingtextbox/)){var r=$.inArray(t.tagName.toLowerCase(),p);if(r>-1){var i=t.tagName.toLowerCase();switch(i){case"img":s.find(".tbpi").css("opacity","1").addClass("slctbt");break;case"a":s.find(".tbli").css("opacity","1").addClass("slctbt");break}}t=t.parentNode}}}function m(e){e.preventDefault();e.stopPropagation();var t=u;t.focus();document.execCommand($(this).data("val"),false,this.value||"");t.focus();Endfocus(u);return false}var e=$(this).hide();var i=$("<div/>",{"class":"postingpin"});e.after(i);var s=$('<div class="textformattingpd"><ul><li class="tbbold txtbutton txtedit"data-val="bold"></li><li class="tbit txtbutton txtedit"data-val="italic"></li><li class="tbud txtbutton txtedit"data-val="underline"></li><li class="tbal txtbutton txtedit"data-val="justifyleft"></li><li class="tbac txtbutton txtedit"data-val="justifycenter"></li><li class="tbarn txtbutton txtedit"data-val="justifyright"></li><li class="tbpi txtedit"data-val=""></li><li class="tbli txtedit"data-val="createlink"></li><li class="tbol txtbutton txtedit"data-val="insertorderedlist"></li><li class="tbul txtbutton txtedit"data-val="insertunorderedlist"></li></ul></div>').appendTo(i);var o=$("<div/>",{"class":"textareaposting"}).appendTo(i).get(0);var u=$("<div/>",{contenteditable:"true","class":"postingtextbox",spellcheck:"false",role:"textbox"}).appendTo(o).get(0);e.data("editable",u);s.find(".txtbutton").on("mousedown",function(e){e.preventDefault();e.stopPropagation();var t=u;t.focus();if(e.target===this){document.execCommand($(this).data("val"),false,this.value||"")}else{document.execCommand($(e.target).parent().data("val"),false,this.value||"")}t.focus();v();return false});var a;var f;var l;var c;s.find(".tbpi").on("mousedown",function(e){e.preventDefault();e.stopPropagation();var i=u;u.focus();doSave(u);a=$('<form id="txt_form" name="txt_form" enctype="multipart/form-data" method="post" action="'+t.url+'"> <div id="txt_camera"> <i class="icon-camera"></i>Upload image </div><input type="file" name="myfile" id="txt_drop" /></form>').appendTo(n.find(".txteditcontent").html(""));f=$('<input type="button" class="txtimgcancel" Value="Cancel" />').appendTo(n.find(".txtcntrlbox").html(""));a.txtimgupload({url:t.url,onStart:function(e,t,n){t===true?l=n:c=n;console.log(n)},onComplete:function(e,t){i.focus();doRestore(u);document.execCommand("insertimage",false,t.url);i.focus();insertNodeAtCaret(document.createTextNode(" "));r.trigger("click")}});n.show();r.show();v();i.focus();return false});var h="";s.find(".tbli").on("mousedown",function(e){e.preventDefault();e.stopPropagation();var t=u;u.focus();doSave(u);t.focus();h=$('<input type="text" class="txtlink" Value="http://" />').appendTo(n.find(".txteditcontent").html(""));f=$('<input type="button" class="txtlnkok" Value="Ok" /><input type="button" class="txtlnkcancel" Value="Cancel" />').appendTo(n.find(".txtcntrlbox").html(""));n.show();r.show();t.focus();return false});n.on("click",".txtlnkok",function(){var e=u;var t=$(h).val();if(t&&t!==""&&t!=="http://"){doRestore(u);document.execCommand("createlink",false,t)}r.trigger("click");return false});r.on("click",function(){if(l)l.abort();else if(c)c.detachEvent();$(this).hide();n.hide();u.focus();doRestore(u);v()});n.on("click",".txtimgcancel,.txteditclose",function(){r.trigger("click")});var p=["img","a"];var d=jQuery.Event("keyup");d.ctrlKey=false;d.which=8;$(u).keydown(function(e){e=e||window.event;var t=e.keyCode||e.which;if(t===9&&!e.shiftKey){e.preventDefault();pastethehtml("<span style='margin-left: 30px;'>ï»¿</span>")}if(e.keyCode===13&&!document.queryCommandState("insertorderedlist")&&!document.queryCommandState("insertunorderedlist")){e.preventDefault();console.log(document.queryCommandState("insertorderedlist"));document.execCommand("insertHTML",false,"<br></br>")}v()});$(u).keyup(function(){v()});$(u).mouseup(function(){v()});})};$.fn.htmlcode=function(e){var t;var n;if(typeof e!=="undefined"){this.each(function(){t=$(this).data("editable");t.innerHTML=e;n=t.innerHTML})}else{t=$(this).data("editable");n=$("<div>"+t.innerHTML+"</div>");n.contents().filter(function(){return this.nodeType===3}).each(function(){this.nodeValue=this.nodeValue.replace(/&/g,"&").replace(/</g,"&lt;").replace(/>/g,"&gt;")});n.find("div").each(function(){var e=this.outerHTML;var t=new RegExp("<"+this.tagName,"i");var n=e.replace(t,"<"+"p");t=new RegExp("</"+this.tagName,"i");n=n.replace(t,"</"+"p");$(this).replaceWith(n)});n=n.html()}return n};$.fn.txtimgupload=function(options){function uploadFile(e){if(checkextension(e)){var t=new FormData;t.append("myfile",e);xhr=new XMLHttpRequest;xhr.upload.addEventListener("progress",progressHandler,false);xhr.addEventListener("load",completeHandler,false);xhr.addEventListener("error",errorHandler,false);xhr.addEventListener("abort",abortHandler,false);xhr.open("POST",""+settings.url+"");xhr.send(t)}}function progressHandler(e){var t=$('<div id="txtprogressbar"><hr id="txtprogresshr"align="left"width="0%"></div>').appendTo(child.parent(".txteditcontent").html(""));bar=t.find("#txtprogresshr");var n=e.loaded/e.total*100;bar.width(Math.round(n)+"%")}function completeHandler(e){var t="100%";bar.width(t);settings.onComplete(child,JSON.parse(e.target.responseText))}function errorHandler(e){}function abortHandler(e){}function isAjaxUploadSupported(){var e=document.createElement("input");e.type="file";return"multiple"in e&&typeof File!=="undefined"&&typeof FormData!=="undefined"&&typeof (new XMLHttpRequest).upload!=="undefined"}function fileExtension(e){var t=["jpeg","jpg","png","gif"];var n=e.split(".").pop().toLowerCase();if(jQuery.inArray(n,t)<0){return false}return true}function checkextension(e){var t=["image/jpeg","image/jpg","image/png","image/gif"];if(jQuery.inArray(e.type,t)<0){alert("Upload only image files");change_back();return false}var n=e.size/1048576;if(n>size){alert("File size limit 5Mb");change_back();return false}return true}function getIframeContentJSON(iframe){try{var doc=iframe.contentDocument?iframe.contentDocument:iframe.contentWindow.document,response;var innerHTML=doc.body.innerHTML;if(innerHTML.slice(0,5).toLowerCase()==="<pre>"&&innerHTML.slice(-6).toLowerCase()==="</pre>"){innerHTML=doc.body.firstChild.firstChild.nodeValue}response=eval("("+innerHTML+")")}catch(err){response={success:false}}return response}function uploaded_file_myFile(e){if(e.status==="success"){completed=true;settings.onComplete(child,e)}else{alert(e.message)}}var settings=$.extend({url:"upload.php",onStart:function(e,t){},onComplete:function(e,t){}},options);var me=$(this);var completed=false;var bar;var frm;var xhr;var cncl;var child;var size=5;var imgbg;var response;var iframeIdmyFile;var dropimg=this;var oldbrw=false;return me.each(function(){child=$(this);completed=false;size=10;dropimg=this;oldbrw=false;child.on("change","#txt_drop",function(){if(!isAjaxUploadSupported()){oldbrw=true;var t=this;var n=t.value;n=n.substring(n.lastIndexOf("/")+1);if(fileExtension(n)){var r=document.createElement("iframe");r.setAttribute("name","upload_iframe_myFile");r.setAttribute("id","upload_iframe_myFile");r.setAttribute("width","0");r.setAttribute("height","0");r.setAttribute("border","0");r.setAttribute("src","javascript:false;");r.style.display="none";var i=document.createElement("form");i.setAttribute("name","myForm");i.setAttribute("id","myForm");i.setAttribute("target","upload_iframe_myFile");i.setAttribute("action",""+settings.url+"");i.setAttribute("method","post");i.setAttribute("enctype","multipart/form-data");i.setAttribute("encoding","multipart/form-data");i.style.display="none";i.appendChild(t);document.body.appendChild(i);document.body.appendChild(r);iframeIdmyFile=document.getElementById("upload_iframe_myFile");settings.onStart(child,false,iframeIdmyFile);var s=function(){if(iframeIdmyFile.detachEvent)iframeIdmyFile.detachEvent("onload",s);else iframeIdmyFile.removeEventListener("load",s,false);response=getIframeContentJSON(iframeIdmyFile);uploaded_file_myFile(response)};if(iframeIdmyFile.addEventListener)iframeIdmyFile.addEventListener("load",s,true);if(iframeIdmyFile.attachEvent)iframeIdmyFile.attachEvent("onload",s);i.submit();var o=$('<div id="txtprogressbar"><hr id="txtprogresshr"align="left"width="0%"></div>').appendTo(child.parent(".txteditcontent").html(""));bar=o.find("#txtprogresshr");return}else{alert("Upload only image files")}}else{frm=child.ajaxSubmit({dataType:"json",beforeSubmit:function(e,t,n){if(!checkextension(e[0].value)){return false}return true},beforeSend:function(e){var t="0%";var n=$('<div id="txtprogressbar"><hr id="txtprogresshr"align="left"width="0%"></div>').appendTo(child.parent(".txteditcontent").html(""));bar=n.find("#txtprogresshr");bar.width(t)},uploadProgress:function(e,t,n,r){var i=r+"%";bar.width(i)},success:function(e,t,n){if(n.responseJSON.status==="success"){var r="100%";bar.width(r);settings.onComplete(child,n.responseJSON)}else{alert(n.responseJSON.message)}},complete:function(e){},resetForm:true});xhr=frm.data("jqxhr");settings.onStart(child,true,xhr)}});child.on("drop",function(e){e.stopPropagation();e.preventDefault();console.log("hey");var t=e.originalEvent.dataTransfer.files;console.log(t);console.log(t.length);if(t.length===1){uploadFile(t[0])}else{alert("One Image allowed");change_back()}})})};var saveSelection,restoreSelection;saveSelection=function(e){if(window.getSelection&&document.createRange){var t=window.getSelection().getRangeAt(0);var n=t.cloneRange();n.selectNodeContents(e);n.setEnd(t.startContainer,t.startOffset);var r=n.toString().length;return{start:r,end:r+t.toString().length}}else if(document.selection&&document.body.createTextRange){var i=document.selection.createRange();var s=document.body.createTextRange();s.moveToElementText(e);s.setEndPoint("EndToStart",i);var r=s.text.length;return{start:r,end:r+i.text.length}}};restoreSelection=function(e,t){if(window.getSelection&&document.createRange){var n=0,r=document.createRange();r.setStart(e,0);r.collapse(true);var i=[e],s,o=false,u=false;while(!u&&(s=i.pop())){if(s.nodeType==3){var a=n+s.length;if(!o&&t.start>=n&&t.start<=a){r.setStart(s,t.start-n);o=true}if(o&&t.end>=n&&t.end<=a){r.setEnd(s,t.end-n);u=true}n=a}else{var f=s.childNodes.length;while(f--){i.push(s.childNodes[f])}}}var l=window.getSelection();l.removeAllRanges();l.addRange(r)}else if(document.selection&&document.body.createTextRange){var c=document.body.createTextRange();c.moveToElementText(e);c.collapse(true);c.moveEnd("character",t.end);c.moveStart("character",t.start);c.select()}};if(!window.addEventListener){window.attachEvent("drop",dropcancel)}else{window.addEventListener("dragover",change,false);window.addEventListener("dragleave",change_back,false);window.addEventListener("drop",dropcancel,false)}$.fn.hidetxt=function(){var e;return this.each(function(){e=$(this).data("editable");$(e).hide()})};$.fn.showtxt=function(){var e;return this.each(function(){e=$(this).data("editable");$(e).show()})}})(jQuery)
